#!/bin/bash

# Filter out the junk in thread dumps, leaving only the important bits.  Turns this mess:
#
# "http-bio-127.0.0.1-8087-exec-44" #524 daemon prio=5 os_prio=0 tid=0x00007f85fc009800 nid=0x339a runnable [0x00007f85e5271000]
#    java.lang.Thread.State: RUNNABLE
#         at java.util.HashMap.put(HashMap.java:612)
#         at org.hibernate.loader.custom.sql.SQLQueryParser$ParameterSubstitutionRecognizer.addNamedParameter(SQLQueryParser.java:328)
#         at org.hibernate.loader.custom.sql.SQLQueryParser$ParameterSubstitutionRecognizer.namedParameter(SQLQueryParser.java:312)
#         at org.hibernate.engine.query.ParameterParser.parse(ParameterParser.java:96)
#         at org.hibernate.loader.custom.sql.SQLQueryParser.substituteParams(SQLQueryParser.java:290)
#         at org.hibernate.loader.custom.sql.SQLQueryParser.process(SQLQueryParser.java:83)
#         at org.hibernate.loader.custom.sql.SQLCustomQuery.<init>(SQLCustomQuery.java:133)
#         at org.hibernate.engine.query.NativeSQLQueryPlan.<init>(NativeSQLQueryPlan.java:67)
#         at org.hibernate.engine.query.QueryPlanCache.getNativeSQLQueryPlan(QueryPlanCache.java:166)
#         at org.hibernate.impl.AbstractSessionImpl.getNativeSQLQueryPlan(AbstractSessionImpl.java:160)
#         at org.hibernate.impl.AbstractSessionImpl.list(AbstractSessionImpl.java:165)
#         at org.hibernate.impl.SQLQueryImpl.list(SQLQueryImpl.java:157)
#         at com.mi.eas.dao.EASDeviceDAOImpl.getEASDeviceSummaryByDeviceId(EASDeviceDAOImpl.java:651)
#         at com.mi.eas.service.EASDeviceServiceImpl.updateEASDeviceSessionTimestamp(EASDeviceServiceImpl.java:1455)
#         at com.mi.eas.service.EASDeviceServiceImpl.updateTunnelSessionTimestamp(EASDeviceServiceImpl.java:1512)
#         at sun.reflect.GeneratedMethodAccessor971.invoke(Unknown Source)
#         at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
#         at java.lang.reflect.Method.invoke(Method.java:498)
#         at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:333)
#         at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:190)
#         at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:157)
#         at org.springframework.orm.hibernate3.HibernateInterceptor.invoke(HibernateInterceptor.java:119)
#         at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179)
#         at com.mi.middleware.interceptor.MITransactionInterceptor.invoke(MITransactionInterceptor.java:96)
#         at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179)
#         at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:213)
#         at com.sun.proxy.$Proxy269.updateTunnelSessionTimestamp(Unknown Source)
#         at sun.reflect.GeneratedMethodAccessor971.invoke(Unknown Source)
#         at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
#         at java.lang.reflect.Method.invoke(Method.java:498)
#         at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:333)
#         at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:190)
#         at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:157)
#         at org.springframework.remoting.support.RemoteInvocationTraceInterceptor.invoke(RemoteInvocationTraceInterceptor.java:78)
#         at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179)
#         at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:213)
#         at com.sun.proxy.$Proxy459.updateTunnelSessionTimestamp(Unknown Source)
#         at sun.reflect.GeneratedMethodAccessor971.invoke(Unknown Source)
#         at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
#         at java.lang.reflect.Method.invoke(Method.java:498)
#         at com.caucho.hessian.server.HessianSkeleton.invoke(HessianSkeleton.java:306)
#         at com.caucho.hessian.server.HessianSkeleton.invoke(HessianSkeleton.java:221)
#         at org.springframework.remoting.caucho.HessianExporter.doInvoke(HessianExporter.java:223)
#         at com.mi.eas.service.CompatibleHessianServiceExporter.doInvoke(CompatibleHessianServiceExporter.java:101)
#         at org.springframework.remoting.caucho.HessianExporter.invoke(HessianExporter.java:138)
#         at org.springframework.remoting.caucho.HessianServiceExporter.handleRequest(HessianServiceExporter.java:66)
#         at org.springframework.web.servlet.mvc.HttpRequestHandlerAdapter.handle(HttpRequestHandlerAdapter.java:51)
#         at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:963)
#         at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:897)
#         at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:970)
#         at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:872)
#         at javax.servlet.http.HttpServlet.service(HttpServlet.java:650)
#         at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:846)
#         at javax.servlet.http.HttpServlet.service(HttpServlet.java:731)
#         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:303)
#         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
#         at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)
#         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)
#         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
#         at org.togglz.servlet.TogglzFilter.doFilter(TogglzFilter.java:100)
#         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)
#         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
#         at org.springframework.orm.hibernate3.support.OpenSessionInViewFilter.doFilterInternal(OpenSessionInViewFilter.java:231)
#         at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
#         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)
#         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
#         at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)
#         at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.invoke(FilterSecurityInterceptor.java:118)
#         at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.doFilter(FilterSecurityInterceptor.java:84)
#         at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
#         at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:113)
#         at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
#         at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:113)
#         at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
#         at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:154)
#         at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
#         at org.springframework.security.web.authentication.www.BasicAuthenticationFilter.doFilter(BasicAuthenticationFilter.java:150)
#         at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
#         at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:50)
#         at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
#         at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
#         at org.springframework.security.web.context.SecurityContextPersistenceFilter.doFilter(SecurityContextPersistenceFilter.java:87)
#         at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
#         at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:192)
#         at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:160)
#         at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:346)
#         at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:262)
#         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)
#         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
#         at com.mi.spring.filters.HTTP401ServletFilter.doFilter(HTTP401ServletFilter.java:41)
#         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)
#         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
#         at org.tuckey.web.filters.urlrewrite.RuleChain.handleRewrite(RuleChain.java:164)
#         at org.tuckey.web.filters.urlrewrite.RuleChain.doRules(RuleChain.java:141)
#         at org.tuckey.web.filters.urlrewrite.UrlRewriter.processRequest(UrlRewriter.java:90)
#         at org.tuckey.web.filters.urlrewrite.UrlRewriteFilter.doFilter(UrlRewriteFilter.java:417)
#         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)
#         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
#         at com.mi.filter.CacheFilter.doFilter(CacheFilter.java:94)
#         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)
#         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
#         at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:219)
#         at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:110)
#         at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:494)
#         at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:169)
#         at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:104)
#         at com.mobileiron.catalina.valves.MobileIronAccessLogValve.invoke(MobileIronAccessLogValve.java:218)
#         at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)
#         at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:445)
#         at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1136)
#         at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:637)
#         at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:316)
#         - locked <0x00007f889fa920f0> (a org.apache.tomcat.util.net.SocketWrapper)
#         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
#         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
#         at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
#         at java.lang.Thread.run(Thread.java:748)
# 
# into this:
# 
# "http-bio-127.0.0.1-8087-exec-44" #524 daemon prio=5 os_prio=0 tid=0x00007f85fc009800 nid=0x339a runnable [0x00007f85e5271000]
#    java.lang.Thread.State: RUNNABLE
#         at java.util.HashMap.put(HashMap.java:612)
#         at com.mi.eas.dao.EASDeviceDAOImpl.getEASDeviceSummaryByDeviceId(EASDeviceDAOImpl.java:651)
#         at com.mi.eas.service.EASDeviceServiceImpl.updateEASDeviceSessionTimestamp(EASDeviceServiceImpl.java:1455)
#         at com.mi.eas.service.EASDeviceServiceImpl.updateTunnelSessionTimestamp(EASDeviceServiceImpl.java:1512)
#         at com.mi.middleware.interceptor.MITransactionInterceptor.invoke(MITransactionInterceptor.java:96)
#         at com.mi.eas.service.CompatibleHessianServiceExporter.doInvoke(CompatibleHessianServiceExporter.java:101)
#         at com.mi.spring.filters.HTTP401ServletFilter.doFilter(HTTP401ServletFilter.java:41)
#         at com.mi.filter.CacheFilter.doFilter(CacheFilter.java:94)
#         at com.mobileiron.catalina.valves.MobileIronAccessLogValve.invoke(MobileIronAccessLogValve.java:218)
#         - locked <0x00007f889fa920f0> (a org.apache.tomcat.util.net.SocketWrapper)
#         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
#         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)

egrep -v 'at (org.(spring|apache|tuckey|togglz)|sun.reflect|java.(util|lang)|com.sun|com.caucho|javax.servlet|java.util.stream|java.io)' "$@" | egrep -v '^[ 	]- locked'

